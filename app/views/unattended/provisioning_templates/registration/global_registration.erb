<%#
kind: registration
name: Global Registration
model: ProvisioningTemplate
-%>
#!/bin/sh
<%
    headers = ["-H 'Content-Type: application/json'", "-H 'Accept: application/json'", "-H 'Authorization: Bearer #{@auth_token}'"]
-%>

# Rendered with following template parameters:
<%= "# User: [#{@user.login}]" -%>
<%= ", Organization: [#{@organization.name}]" if @organization -%>
<%= ", Location: [#{@location.name}]" if @location -%>
<%= ", Hostgroup: [#{@hostgroup.name}]" if @hostgroup -%>


if ! [ $(id -u) = 0 ]; then
    echo "Please run as root"
    exit 1
fi

if [ -f /etc/os-release ] ; then
  . /etc/os-release
fi

create_host_curl() {
  curl --fail --request POST <%= foreman_server_url %>/api/hosts \
       <%= headers.join(' ') %> \
       -d '{ "host": { "name": "'$(hostname --fqdn)'", "build": "false", "managed": "false"
       <%= ", \"organization_id\": \"#{@organization.id}\"" if @organization -%>
       <%= ", \"location_id\": \"#{@location.id}\"" if @location -%>
       <%= ", \"hostgroup_id\": \"#{@hostgroup.id}\"" if @hostgroup -%>
       }}'
}

exit_on_error() {
    echo ""
    echo "Host registration failed"
    exit 1
}

echo "#"
echo "# Running registration"
echo "#"

<% if plugin_present?('katello') -%>
if [ x$ID = xrhel ] || [ x$ID = xcentos ]; then
    CONSUMER_RPM=$(mktemp --suffix .rpm)

    curl --insecure --output $CONSUMER_RPM <%= subscription_manager_configuration_url %>
    yum localinstall $CONSUMER_RPM -y
    yum install subscription-manager -y
    subscription-manager register --org=<%= @organization.label %> --activationkey="sample-key" || exit_on_error
    rm -f $CONSUMER_RPM

    TOKEN=$(curl -s -X GET "<%= foreman_server_url %>/api/hosts/$(hostname --fqdn)" <%= headers.join(' ') %> | grep -Po '(?<=\"registration_token\":")([^\"]+)')
else
    TOKEN=$(create_host_curl | grep -Po '(?<=\"registration_token\":")([^\"]+)') || exit_on_error
fi
<% else -%>
TOKEN=$(create_host_curl | grep -Po '(?<=\"registration_token\":")([^\"]+)') || exit_on_error
<% end -%>

curl -X GET "<%= foreman_server_url %>/foreman_register/hosts/register?token=$TOKEN" | bash
